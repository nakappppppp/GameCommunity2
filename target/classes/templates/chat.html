<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイムチャット</title>
    <link rel="stylesheet" href="/css/output.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
</head>
<body class="bg-gray-100">

    <div class="max-w-3xl mx-auto mt-10 p-5 bg-white shadow-lg rounded-lg">
        <h1 class="text-2xl font-semibold text-center text-indigo-600 mb-6">リアルタイムチャット</h1>

        <!-- チャットメッセージ表示領域 -->
        <div id="messagesContainer" class="h-80 overflow-y-scroll bg-gray-50 p-4 rounded-lg border border-gray-300 mb-4">
            <!-- メッセージがここに表示される -->
        </div>

        <!-- メッセージ送信用フォーム -->
        <form id="chatForm" class="flex flex-col">
            <textarea id="messageContent" rows="3" class="p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="メッセージを入力..."></textarea>
            <button type="submit" class="self-end bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors">送信</button>
        </form>
    </div>

    <script>
        var stompClient = null;

        // WebSocket接続を確立
        function connect() {
            var socket = new SockJS('/chat');  // WebSocketエンドポイントに接続
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/messages', function(response) {
                    var chatMessage = JSON.parse(response.body);
                    displayMessage(chatMessage);
                });
            }, function(error) {
                console.error('WebSocket Error: ' + error);
            });
        }

        // メッセージを送信
        document.getElementById('chatForm').onsubmit = function(event) {
            event.preventDefault();  // ページ遷移を防止

            var messageContent = document.getElementById('messageContent').value;
            if (messageContent && stompClient) {
                var chatMessage = {
                    user: { id: 1 },  // ユーザーID（適宜変更）
                    content: messageContent,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                console.log('Sending message: ', chatMessage);  // デバッグ用
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                document.getElementById('messageContent').value = '';  // 入力欄をクリア
            } else {
                console.log('メッセージが空です');  // メッセージが空の場合のデバッグ用
            }
        };

        // メッセージを画面に表示
        function displayMessage(chatMessage) {
            var messageContainer = document.getElementById('messagesContainer');
            var messageElement = document.createElement('div');
            messageElement.classList.add('mb-4', 'p-3', 'bg-indigo-100', 'rounded-lg', 'text-gray-800', 'shadow-sm', 'max-w-xl', 'w-full');
            messageElement.textContent = chatMessage.content;
            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;  // 最後のメッセージが表示されるようにスクロール
        }

        // 初期化
        connect();
    </script>

</body>
</html>
